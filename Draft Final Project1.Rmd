---
title: "Final Project Data 205"
author: "Tiffany King"
date: "11/18/2021"
output: html_document
---

# Loading Libraries
```{r}
library('rvest')
library(tidyverse)
library(psych)
library(readr)
library(dplyr)
library(lubridate)
library(ggplot2)
library(plotly)
library(plyr)
library(highcharter)
library(RColorBrewer)
```
# Setting working directory
```{r}
setwd("/Users/tiffanyking/Desktop/DATA 205/DATA205/DATA205")
```

```{r}
WKridership<- read_csv("2019 Ridership weekday average.csv")
crimes<-read_csv("crime.csv")
``` 
# Examine the data
```{r}
str(WKridership)
head(WKridership)
```
## create dataframe from CSV
```{r}
year<- c("2010","2011","2012","2013","2014","2015","2016","2017","2018","2019","2020","2021")
averider<- c(705563,737313,721225,706591,693705,675077,621079,613665,605910,626269,176602,125557)
dailyentriesride<-data.frame(year,averider)
print(dailyentriesride)
```
# Barplot Average Daily Entries 
```{r}
options(scipen = 999)
ggplot(data=dailyentriesride, aes(x=year, y=averider)) +
  geom_bar(stat="identity", fill="red")+
  geom_text(aes(label=averider), vjust=1.6, color="white", size=3.5)+
   xlab("Year") +
  ylab("Passengers") +
  ggtitle("Average Daily Entries By Train") +
  ylim(0,800000)
  theme_minimal()
```
##Barplot Average Daily Entries by Bus

```{r}
year<- c("2010","2011","2012","2013","2014","2015","2016","2017","2018","2019","2020","2021")
averider<- c(705563,737313,721225,706591,693705,675077,621079,613665,605910,626269,176602,125557)
dailyentriesride<-data.frame(year,averider)
print(dailyentriesride)
```


## Getting the WMATA Data
```{r}
library(tidyverse)
library(pdftools)
library(httr)
```

```{r}
get_wmata_data <- function(pdflink) {
  wmata_data <- pdf_text(pdflink) %>%
    str_split("\n")
  
  df = ""
  
  for (i in 1:length(wmata_data)) {
   
    for (line in wmata_data[[i]][9:(length(wmata_data[[i]])-2)]) {
      if (line == "" | is.na(line))
      {
        next
      } else {
        line <- str_squish(line)
        
        if (substr(line,21,27) %in% c("SUMMONS"))
        {
          stub <- str_split_fixed(line, " - ", 2)
          state <- substr(stub[1], nchar(stub[1])-1, nchar(stub[1]))
          stub_1 <- substr(stub[1],1, nchar(stub[1])-3)
          stub_2 <- stub[2]
          line <- paste(stub_1, stub_2, "\n")
          line <- paste(substr(line, 1, 36), state, " ", substr(line, 37, nchar(line)))
          prev_line <- line
          #print(line)
        }
        
        if (substr(line,21,27) %in% c("ARREST ", "REPORT "))
        {
          line <- paste(substr(line,1,26), "        ", substr(line,27,nchar(line)))
          stub <- str_split_fixed(line, " - ", 2)
          state <- substr(stub[1], nchar(stub[1])-1, nchar(stub[1]))
          stub_1 <- substr(stub[1],1, nchar(stub[1])-3)
          stub_2 <- stub[2]
          line <- paste(stub_1, stub_2, "\n")
          line <- paste(substr(line, 1, 36), state, " ", substr(line, 37, nchar(line)))
          prev_line <- line
          #print(line)
        }
        
        if (substr(line,3,3) !="/")
        {
          offense_stub <- str_split_fixed(line, " - ", 2)
          
          if (offense_stub[2]  != "")
          {
            line <- paste(stub_1, substr(line,6,nchar(line)))
            line <- paste(substr(line, 1, 36), state, " ", substr(line, 37, nchar(line)), "\n")
          }else{
            df <- substr(df, 1, nchar(df)-nchar(prev_line))
            line <- paste(substr(prev_line,1,nchar(prev_line)-2), offense_stub[1], "\n")
          }
        }
        
        df <- paste(df, line)
        print(line)
      }
    }
  }
  return(read_fwf(df, 
                  col_types=cols('c','c','c','c','c'),
                  fwf_cols(date=12, time=9, type=17, state=4, desc=NA)))
}
#fwf_cols(date=12, time=9, type=17, state=4, desc=NA),
# Now define what the links to the pdf files should look like and create a
# way to iterate through them to get multiple files at one go.

url <- "https://www.wmata.com/about/transit-police/upload/Monthly-Blotter-"
time_periods <- c("October-2021","September-2021", "August-2021", "July-2021", "June-2021","May-2021","April-2021","March-2021","February-2021","January-2021")

url <- "https://www.wmata.com/about/transit-police/upload/Monthly-Blotter-"

time_periods <- c("December-2020","November-2020","October-2020","September-2020", "August-2020", "July-2020", "June-2020","May-2020","April-2020","March-2020","February-2020","January-2020")

df_prev = ""

for (time_period in time_periods) {
  pdflink <- paste0(url, time_period, ".pdf")
  df_curr <- get_wmata_data(pdflink)

  if (df_prev == "")
  {
    df_prev <- df_curr
    df_wmata <- df_prev
  } else {
    df_wmata <- bind_rows(df_wmata, df_curr)
  }
}

# Check to make sure the data starts with start month and ends with end month.
df_wmata
tail(df_wmata)

```

# Create Plot
```{r}
df.groupby('year').type.value_counts().unstack(0).plot.barh()

```

